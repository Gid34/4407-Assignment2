#!/bin/bash
# Usage: ./preprocess <input_file>
# Output goes to STDOUT

input_file="$1"

# Convert line endings to Unix, fix decimal comma, convert delimiter, remove non-ASCII
tmp_file=$(mktemp)
tr -d '\r' < "$input_file" |
    sed 's/,/./g' |
    tr -cd '\11\12\15\40-\176' |
    sed 's/;/\t/g' > "$tmp_file"

# Fix missing IDs
# Extract max ID
max_id=$(awk -F'\t' 'NR>1 && $1 ~ /^[0-9]+$/ && $1 > max { max = $1 } END { print max }' "$tmp_file")
new_id=$((max_id + 1))

# Read and replace empty IDs
{
    read -r header
    echo "$header"
    while IFS=$'\t' read -r -a line; do
        if [[ -z "${line[0]}" ]]; then
            line[0]=$new_id
            ((new_id++))
        fi
        (IFS=$'\t'; echo "${line[*]}")
    done
} < "$tmp_file"

rm "$tmp_file"