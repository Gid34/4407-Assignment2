#!/bin/bash
# Usage: ./analysis <cleaned_file>

input_file="$1"

# Remove header
data=$(tail -n +2 "$input_file")

# Count most common mechanic
mechanic=$(echo "$data" | cut -f13 | tr ',' '\n' | sed 's/^ *//;s/ *$//' | grep -v '^$' | sort | uniq -c | sort -nr | head -n1)
echo "The most popular game mechanics is $(echo "$mechanic" | awk '{$1=""; print $0}' | sed 's/^ *//') found in $(echo "$mechanic" | awk '{print $1}') games"

# Count most common domain
domain=$(echo "$data" | cut -f14 | tr ',' '\n' | sed 's/^ *//;s/ *$//' | grep -v '^$' | sort | uniq -c | sort -nr | head -n1)
echo "The most style of game is $(echo "$domain" | awk '{$1=""; print $0}' | sed 's/^ *//') found in $(echo "$domain" | awk '{print $1}') games"

# Pearson correlation helper function
function pearson_corr() {
    awk -F'\t' -v xcol="$1" -v ycol="$2" '
    {
        x = $xcol; y = $ycol;
        if (x != "" && y != "") {
            sumx += x; sumy += y;
            sumx2 += x*x; sumy2 += y*y;
            sumxy += x*y; n++;
        }
    }
    END {
        num = n * sumxy - sumx * sumy;
        den = sqrt((n*sumx2 - sumx^2)*(n*sumy2 - sumy^2));
        if (den == 0) {
            print "undefined";
        } else {
            printf "%.3f\n", num / den;
        }
    }'
}

# Correlation between Year Published (3rd col) and Rating Average (9th)
corr1=$(pearson_corr 3 9 <<< "$data")
echo "The correlation between the year of publication and the average rating is $corr1"

# Correlation between Complexity Average (11th col) and Rating Average (9th)
corr2=$(pearson_corr 11 9 <<< "$data")
echo "The correlation between the complexity of a game and its average rating is $corr2"
